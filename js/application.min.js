
var width=150;var height=100;var cellSize=6;var state=[];var speed=70;var liveCount,timer,c,canvas,tool;var background='#E4DD98';var gridColor='#9B9365';var cell='#383302';mvX=0;mvY=0;lastX=0;lastY=0;$(function(){buttons();patternsFunc();randomize();render(state);drawHandler();selectmenu();});function buttons(){$('#status').click(function(){if($(this).children('span').html()=='pause'){$(this).children('span').html('play');}else{$(this).children('span').html('pause');}
$(this).children('span').toggleClass('active');createNext();return false;});$('#reset').click(function(){stopGame();randomize();render(state);$('#pattern').val('0');$('.ui-selectmenu-status').text('load a pattern');$('.ui-selectmenu-menu').find('li').removeClass('ui-selectmenu-item-selected').removeClass('ui-state-active').removeClass('ui-selectmenu-item-focus').removeClass('ui-state-hover').find('a').attr('aria-selected','false')
$('.ui-selectmenu-menu').find('li:eq(0)').addClass('ui-selectmenu-item-selected').addClass('ui-state-active').find('a').attr('aria-selected','true')});$('#clear').click(function(){stopGame();canvas.clearRect(0,0,width*cellSize,height*cellSize);makeGrid();for(i=0;i<height;i++){state[i]=[];}});}
function patternsFunc(){for(i=0;i<patterns.length;i++){$('#pattern').append('<option value="'+i+'">'+patterns[i].name+'</option>');}
$('#pattern').change(function(){if($(this).val()>0){stopGame();pattern=patterns[$(this).val()];state=[];offW=Math.round(width/2-pattern.width/2);offH=Math.round(height/2-pattern.height/2);$.each(pattern.data,function(index,value){x=value[0]+offH;y=value[1]+offW;if(!state[x]){state[x]=[];}
state[x][y]=1;});ih=0;while(ih<height){if(!state[ih]){state[ih]=[];}
ih++;}
render(state);}});}
function stopGame(){$('#status').children('span').removeClass('active').html('play');$('#count').html(0);clearTimeout(timer);}
function randomize(){ih=0;while(ih<height){state[ih]=[];iw=0;while(iw<width){ran=Math.floor(Math.random()*2);(ran==1)?state[ih][iw]=1:'';iw++;}
ih++;}}
function makeGrid(){grid=$('#grid');cGrid=grid[0].getContext('2d');grid[0].width=width*cellSize;grid[0].height=height*cellSize;$('#canvases').css({'width':width*cellSize,'height':height*cellSize});cGrid.fillStyle=background;cGrid.fillRect(0,0,width*cellSize,height*cellSize);for(var x=0.5;x<width*cellSize;x+=cellSize){cGrid.moveTo(x,0);cGrid.lineTo(x,height*cellSize);}
for(var y=0.5;y<height*cellSize;y+=cellSize){cGrid.moveTo(0,y);cGrid.lineTo(width*cellSize,y);}
cGrid.strokeStyle=gridColor;cGrid.stroke();}
function render(lifeArray){c=$('#container');canvas=c[0].getContext('2d');c[0].width=width*cellSize;c[0].height=height*cellSize;canvas.clearRect(0,0,width*cellSize,height*cellSize);canvas.fillStyle=cell;makeGrid();ih=0;while(ih<height){iw=0;while(iw<width){if(lifeArray[ih][iw]){canvas.fillRect(iw*cellSize,ih*cellSize,cellSize,cellSize);}
iw++;}
ih++;}}
function createNext(){newState=[];ih=0;while(ih<height){newState[ih]=[];iw=0;while(iw<width){newState[ih][iw]=logic(state[ih][iw],getSurroundings(ih,iw));iw++;}
ih++;}
state=newState;render(state);$('#count').html(commaFormat(parseInt($('#count').text().replace(/,/g,''),10)+1));if($('#status span').hasClass('active')){timer=setTimeout("createNext();",speed);}}
function getSurroundings(y,x){liveCount=0;if(x+1>=width){next=width-1-x;}else{next=x+1;}
if(state[y][next]){liveCount+=1;}
if(x<=0){prev=width-1-x;}else{prev=x-1;}
if(state[y][prev]){liveCount+=1;}
if(y-1<0){aboveY=height-1;}else{aboveY=y-1;}
if(state[aboveY][x]){liveCount+=1;}
if(state[aboveY][prev]){liveCount+=1;}
if(state[aboveY][next]){liveCount+=1;}
if(y+1==height){belowY=0}else{belowY=y+1;}
if(state[belowY][x]){liveCount+=1;}
if(state[belowY][prev]){liveCount+=1;}
if(state[belowY][next]){liveCount+=1;}
return liveCount;}
function logic(current,liveCount){if(current==1){if(liveCount<2){return 0;}
if(liveCount==2||liveCount==3){return 1;}
if(liveCount>3){return 0;}}else{if(liveCount==3){return 1;}else{return 0;}}}
function drawHandler(){clicked=false;cOff=c.offset();c.mousemove(function(e){checkCoords(e);});$('body').mousedown(function(ev){clicked=true;getCoords(ev);if(mvX<width&&mvY<height&&mvX>0&&mvY>0){if(state[mvY][mvX]){tool='erase';}else{tool='draw';}
draw(mvX,mvY);}}).mouseup(function(){clicked=false;});}
function checkCoords(ev){getCoords(ev);if((mvX<width&&mvY<height)&&(mvX!=lastX||mvY!=lastY)){lastX=mvX;lastY=mvY;if(clicked){draw(mvX,mvY);}}}
function getCoords(ev){mvX=Math.floor((ev.pageX-cOff.left)/cellSize);mvY=Math.floor((ev.pageY-cOff.top)/cellSize);}
function draw(x,y){if(tool=='draw'){canvas.fillRect(x*cellSize,y*cellSize,cellSize,cellSize);state[y][x]=1;}else if(tool=='erase'){canvas.clearRect(x*cellSize,y*cellSize,cellSize,cellSize);delete state[y][x];}}
function selectmenu(){$('#pattern').selectmenu();}
function commaFormat(nStr){nStr+='';x=nStr.split('.');x1=x[0];if(x.length>1){x2='.'+x[1];}else{x2='';}
rgx=/(\d+)(\d{3})/;while(rgx.test(x1)){x1=x1.replace(rgx,'$1'+','+'$2');}
return x1+x2;}